package main

import (
	"bufio"
	"errors"
	"log"
	"math/rand"
	"os"
	"strings"
	"time"

	"github.com/qor/media/media_library"

	"github.com/NewTrident/iFunnyHub/app/models"
	"github.com/NewTrident/iFunnyHub/db"
)

func main() {
	file, err := os.Open("/tmp/game.txt")
	if err != nil {
		log.Fatal(err)
	}
	defer file.Close()

	scanner := bufio.NewScanner(file)

	s := rand.NewSource(time.Now().Unix())
	r := rand.New(s)
	for scanner.Scan() {
		strs := strings.Split(scanner.Text(), "|")
		fileName := strs[1]
		// pFileName := fileName + "_s"
		title := strs[0]
		tagStr := strs[2]

		tag := models.Tag{}
		db.DB.Model(&models.Tag{}).Where("name = ?", tagStr).Find(&tag)
		if tag.ID == 0 {
			tag.Name = tagStr
			db.DB.Create(&tag)
		}

		category := models.Category{}
		db.DB.Model(&models.Category{}).Where("code = ?", "game").Find(&category)
		if category.ID == 0 {
			panic(errors.New("none category"))
		}

		image := media_library.File{
			FileName: fileName,
			Url:      "//static.ifunnyhub.com/game/" + fileName + "/img/" + "top.png",
		}
		image1 := media_library.File{
			FileName: fileName,
			Url:      "//static.ifunnyhub.com/game/" + fileName + "/img/" + "1.png",
		}
		image2 := media_library.File{
			FileName: fileName,
			Url:      "//static.ifunnyhub.com/game/" + fileName + "/img/" + "2.png",
		}
		image3 := media_library.File{
			FileName: fileName,
			Url:      "//static.ifunnyhub.com/game/" + fileName + "/img/" + "3.png",
		}
		pImage := media_library.File{
			FileName: fileName,
			Url:      "//static.ifunnyhub.com/game/" + fileName + "/img/" + "game.png",
		}

		mb := models.MediaBox{
			media_library.MediaBox{
				Files: []media_library.File{image, image1, image2, image3},
			},
		}
		pMb := models.MediaBox{
			media_library.MediaBox{
				Files: []media_library.File{pImage},
			},
		}

		item := models.Item{}
		item.Title = title
		item.Tags = append(item.Tags, tag)
		item.Category = category
		item.File = mb
		item.MainIMG = pMb
		item.ManualUpload = true
		item.Link = "//static.ifunnyhub.com/game/" + fileName + "/index.html"

		item.Seed = r.Float64()

		db.DB.Create(&item)
	}

	if err := scanner.Err(); err != nil {
		log.Fatal(err)
	}

	// media_library.MediaOption{
	// 	FileName: "",
	// 	Url:      "",
	// }

}
